## https://k3d.io/stable/#install-specific-release
k3d cluster create github-actions

(cd k3d-demo && k3d cluster create github-actions --api-port 6550  --servers 3 --port 8080:80@loadbalancer --volume $(pwd)/sample:/src@all --wait)

k3d cluster create --config k3d-config.yaml

### GitHub repository token:
git remote set-url origin git@dr.magel:drmagel/github-actions.git
git remote -v

### ~/.ssh/config:
host dr.magel
  HostName github.com
  IdentityFile ~/.ssh/drgh_rsa
  User git

### New SSH key in GitHub:
~/.ssh/drgh_rsa.pub

### GPG and Pass: 12GPGPass-=
gpg --list-secret-keys --keyid-format LONG
pass init 0F05FE567CFD0C93

pass insert github-actions/token

TOKEN=$(pass github-actions/token)

## ARC

### Certificate manager
helm repo add jetstack https://charts.jetstack.io --force-update

helm install \
  cert-manager jetstack/cert-manager \
  --namespace cert-manager \
  --create-namespace \
  --version v1.19.1 \
  --set crds.enabled=true

### ARC
helm repo add actions-runner-controller https://actions-runner-controller.github.io/actions-runner-controller
helm upgrade --install --namespace actions-runner-system --create-namespace \
             --wait actions-runner-controller actions-runner-controller/actions-runner-controller

### Personal Authentication Token (PAT)
(PAT)(https://github.com/actions/actions-runner-controller/blob/master/docs/authenticating-to-the-github-api.md#deploying-using-pat-authentication)

kubectl -n actions-runner-system \
    delete secret controller-manager || true
GITHUB_TOKEN=$(pass github-actions/token)
kubectl -n actions-runner-system \
    create secret generic controller-manager \
    --from-literal=github_token=${GITHUB_TOKEN}
unset GITHUB_TOKEN

### Build the image
docker rmi local-registry:3000/github-actions-runner:built || true
docker build -t local-registry:3000/github-actions-runner:built image
docker push local-registry:3000/github-actions-runner:built


## GitHub APIs
### https://docs.github.com/en/rest/actions/self-hosted-runners?apiVersion=2022-11-28#list-self-hosted-runners-for-a-repository
curl -L \
  -H "Accept: application/vnd.github+json" \
  -H "Authorization: Bearer $TOKEN" \
  -H "X-GitHub-Api-Version: 2022-11-28" \
  https://api.github.com/repos/drmagel/github-actions/actions/runners

curl -L \
  -H "Accept: application/vnd.github+json" \
  -H "Authorization: Bearer $TOKEN" \
  -H "X-GitHub-Api-Version: 2022-11-28" \
  https://api.github.com/repos/drmagel/github-actions/actions/runners/downloads

  curl -L \
  -X POST \
  -H "Accept: application/vnd.github+json" \
  -H "Authorization: Bearer $TOKEN$" \
  -H "X-GitHub-Api-Version: 2022-11-28" \
  https://api.github.com/repos/drmagel/github-actions/actions/runners/generate-jitconfig \
  -d '{"name":"GitHub Actions Repository","runner_group_id":1,"labels":["self-hosted","ARM64","macOS","no-gpu"],"work_folder":"/tmp/work"}'

  RUNNER=$(curl -s -L \
  -X POST \
  -H "Accept: application/vnd.github+json" \
  -H "Authorization: Bearer $TOKEN" \
  -H "X-GitHub-Api-Version: 2022-11-28" \
  https://api.github.com/repos/drmagel/github-actions/actions/runners/registration-token | jq -r '.token')

## Self-hosted runner
  https://github.com/drmagel/github-actions/settings/actions/runners
