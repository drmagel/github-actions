{{ $name := printf "%s-%s" .Release.Name "dind" }}
{{ $namespace := .Release.Namespace }}

{{ with .Values.runner }}
{{ $repository := .repository }}
{{ $replicas := .replicas}}
{{ $image := printf "%s:%s" .image.registry .image.tag }}
{{ range .architecture }}
{{ $arch := . }}
---
apiVersion: actions.summerwind.dev/v1alpha1
kind: RunnerDeployment
metadata:
  name: {{ $name }}-{{ $arch }}
  namespace: {{ $namespace }}
spec:
  template:
    spec:
      repository: {{ $repository }}
      labels:
        - docker
        - dind
        - {{ $arch }}
      ephemeral: true
      dockerdWithinRunnerContainer: false
      # nodeSelector:
      #   kubernetes.io/arch: {{ $arch }}
      containers:
        - name: runner
          # image: summerwind/actions-runner-dind:latest
          image: {{ $image }}
          env:
            - name: DOCKER_HOST
              value: tcp://localhost:2375

        - name: docker
          image: docker:24-dind
          securityContext:
            privileged: true
          args: ["--host=tcp://0.0.0.0:2375"]
          volumeMounts:
            - name: docker-graph-storage
              mountPath: /var/lib/docker

      volumes:
        - name: docker-graph-storage
          emptyDir: {}
{{ end }}
{{ end }}